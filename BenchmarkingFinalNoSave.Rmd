---
title: "BenchmarkingFinal"
author: "Lgan Wright"
date: "July 15, 2019"
output: pdf_document
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
options(stringsAsFactors = F)
library("RforProteomics")
#library("plyr")
library('MSstats', warn.conflicts = F, quietly = T, verbose = F)
library("NormalyzerDE")
library("knitr")
library("foreach")
library("genefilter")
library(ROTS); library(data.table);
library(SpikeInSubset); library(limma); library(PECA); library(readxl); 
library(dplyr); library(tidyr); library(ggplot2); library(ggthemes); 
library(printr); library(mratios); library(extrafont); library(qvalue)
knitr::opts_chunk$set(echo = TRUE)

#install.packages("quantreg")
#BiocManager::install("MSnbase")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r main function, echo = FALSE}
min <- function(input, quant) {
  inputLong <- gather(input, run, intensity, 4:19) %>% filter(!is.na(intensity))
  a
  inputLong$condition <- NA
  inputLong[grep("1x", inputLong$run), "condition"] <- "1x"
  inputLong[grep("2x", inputLong$run), "condition"] <- "2x"

  inputLong$quant <- NA
  inputLong[grep("dia", inputLong$run), "quant"] <- "DIA"
  inputLong[grep("dda", inputLong$run), "quant"] <- "DDA"
  
  protein_counts <- inputLong %>% group_by(quant, condition, species) %>% 
  summarize(count = length(unique(peptide)))

  g <- ggplot(protein_counts, aes(x = condition, y = count, fill = species))
  g <- g + geom_bar(stat = "identity") + facet_grid(. ~ quant)
  g  + theme_pander(base_size = 19) + scale_fill_economist() + 
    theme(text=element_text(size=19,family="serif")) + xlab("E. Coli spike-in ratio") + 
    ylab("Peptide count") +  theme(axis.ticks = element_blank()) + 
    theme(axis.title.y=element_text(margin=margin(0,20,0,0))) + 
    theme(axis.title.x=element_text(margin=margin(20,0,0,0)))
  AUC = 8
  return(AUC)
}

```

```{r DDA Peptide Input, echo = FALSE}
conditions <- read.csv("annotation.csv")
conditions <- conditions[,1:2]
names(conditions) <- c("run", "condition")


dda <- read.csv("peptides.csv")
dda <- dda[, c(1, 37, grep("Intensity", names(dda)))]
names(dda)[4:19] <- unlist(lapply(names(dda)[4:19], function(x) {
  unlist(strsplit(x, "\\."))[1]
}))
dda <- dda[,-3]
dda <- gather(dda, run, intensity, 3:18, convert = TRUE, factor_key = TRUE)
dda$run <- as.character(dda$run)
dda <- merge(dda, conditions)
rm(conditions)

names(dda)[2] <- "peptide"

dda$quant <- "dda"
dda$condition <- do.call(paste, c(dda[,c("run", "condition", "quant")], sep = "_"))
dda <- dda[,-1]

dda$species <- NA
dda[grep("HUMAN", dda$Species), "species"] <- "human"
dda[grep("ECOLI", dda$Species), "species"] <- "ecoli"
dda <- dda[which(!is.na(dda$species)), ]
dda <- dda[,-2]
dda <- dda[which(dda$intensity != 0), ]

# There are only six duplicate quants for proteins in the same run. I'm 
# unsure why MaxQuant is doing this. Perhaps it is for a different modification 
# state of that protein? There are very few, so I will just remove the
# duplicates. 
dda <- dda[which(!duplicated(dda[ , c("peptide", "condition", "species")])), ]

ddaPep <- spread(dda, condition, intensity)
#write.csv(ddaPep, "dda_peptide_wide.csv", row.names = F)
#write.table(ddaPep, "dda_peptide_wide.tsv", row.names=FALSE, sep="\t", quote = FALSE)

ddaPep <- read.csv("dda_peptide_wide.csv")

#Shows IDed peptide counts across conditions
counter(ddaPep)

ddaPep <- ddaPep %>% select(-quant)

lddaPep <- gather(ddaPep, run, intensity, 3:18) %>% filter(!is.na(intensity))
# Filter out those near zero.
lddaPep <- lddaPep[which(lddaPep$intensity > 10), ]

#write.csv(lddaPep, "dda_peptide_long.csv", row.names = F)
out_dir = "C:/Users/Logan Wright/R Scripts/NormalyzerOutput/"
normalyzer(
  jobName="DDA_PeptideNormalization",
  designPath="C:/Users/Logan Wright/DDA_Design_Matrix.txt", 
  dataPath= "C:/Users/Logan Wright/R Scripts/dda_peptide_wide.tsv",
  outputDir= out_dir,
  zeroToNA =TRUE,
  requireReplicates = FALSE)

# Add Normalization identifier column and combine all text files
list_of_files <- list.files(path = "C:/Users/Logan Wright/R Scripts/NormalyzerOutput/DDA_PeptideNormalization/", recursive = TRUE,
                            pattern = "\\.txt$", 
                            full.names = TRUE)
DDA_Peptide_Matrix <- rbindlist(sapply(list_of_files, fread, simplify = FALSE),
                use.names = TRUE, idcol = "FileName")

#write.csv(DDA_Peptide_Matrix, "DDA_Peptide_Matrix.csv", row.names = FALSE)
```

```{r DDA Protein Input, echo = FALSE}
conditions <- read.csv("annotation.csv")
conditions <- conditions[,1:2]
names(conditions) <- c("run", "condition")


dda <- read.csv("proteinGroups.csv")
dda <- dda[, c(8, grep("LFQ", names(dda)))]
names(dda)[2:17] <- unlist(lapply(names(dda)[2:17], function(x) {
  unlist(strsplit(x, "\\."))[3]
}))
dda <- gather(dda, run, intensity, 2:17, convert = TRUE, factor_key = TRUE)
dda$run <- as.character(dda$run)
dda <- merge(dda, conditions)
rm(conditions)

names(dda)[2] <- "protein"

dda$quant <- "dda"
dda$condition <- do.call(paste, c(dda[,c("run", "condition", "quant")], sep = "_"))
dda <- dda[,-1]

dda$species <- NA
dda[grep("HUMAN", dda$protein), "species"] <- "human"
dda[grep("ECOLI", dda$protein), "species"] <- "ecoli"
dda <- dda[which(!is.na(dda$species)), ]

dda <- dda[which(dda$intensity != 0), ]

# There are only six duplicate quants for proteins in the same run. I'm 
# unsure why MaxQuant is doing this. Perhaps it is for a different modification 
# state of that protein? There are very few, so I will just remove the
# duplicates. 
dda <- dda[which(!duplicated(dda[ , c("protein", "condition", "species")])), ]

ddaProt <- spread(dda, condition, intensity)

#write.csv(ddaProt, "dda_protein_wide.csv", row.names = F)
#write.table(ddaProt, "dda_protein_wide.tsv", row.names=FALSE, sep="\t", quote = FALSE)

ddaProt <- read.csv("dda_protein_wide.csv")

#Shows IDed protein counts across conditions
counter(ddaProt)

ddaProt <- ddaProt %>% select(-quant)

lddaProt <- gather(ddaProt, run, intensity, 3:18) %>% filter(!is.na(intensity))
# Filter out those near zero.
lddaProt <- lddaProt[which(lddaProt$intensity > 10), ]

#write.csv(lddaProt, "dda_protein_long.csv", row.names = F)

normalyzer(
  jobName="DDA_ProteinNormalization", 
  designPath="C:/Users/Logan Wright/DDA_Design_Matrix.txt",
  dataPath="C:/Users/Logan Wright/R Scripts/dda_protein_wide.tsv",
  outputDir="C:/Users/Logan Wright/R Scripts/",
  zeroToNA =TRUE,
  requireReplicates = FALSE)
list_of_files <- list.files(path = "C:/Users/Logan Wright/R Scripts/DDA_ProteinNormalization/", recursive = TRUE,
                            pattern = "\\.txt$", 
                            full.names = TRUE)
DDA_Protein_Matrix <- rbindlist(sapply(list_of_files, fread, simplify = FALSE),
                use.names = TRUE, idcol = "FileName")

#write.csv(DDA_Protein_Matrix, "DDA_Protein_Matrix.csv", row.names = FALSE)
```

```{r DIA Peptide Input, echo = FALSE}
dia <- read.csv("20190617_122759_EA100915_Benchmarkv2_Report.csv")
#Rolled up on ms2 - avg
dia <- dia[,c(1,2,6,7,11)]
names(dia) <- c("condition", "run", "protein", "peptide", "ms2_peak")

for(i in 1:length(dia$ms2_peak)) {
  if (dia[i,]$ms2_peak < 1) {
   dia[i,]$ms2_peak = 0 
  }
}

dia$species <- NA
dia[grep("HUMAN", dia$protein), "species"] <- "human"
dia[grep("ECOLI", dia$protein), "species"] <- "ecoli"
# There's ~80 bovine, pig, and keratin hits. These are likely flagged by the 
# database search as common contaminants. 
dia <- dia[which(!is.na(dia$species)), ]

dia$quant <- "dia"
dia$condition <- do.call(paste, c(dia[,c("run", "condition", "quant")], sep = "_"))
dia <- dia[,-2:-3]
#Remove duplicates
dia <- dia[which(!duplicated(dia[ , c("peptide", "condition", "species")])), ]
dia <- dia[which(dia$ms2_peak > 1), ]

diaPep <- spread(dia, condition, ms2_peak)

#write.csv(diaPep, "dia_peptide_wide.csv", row.names = F)
#write.table(diaPep, "dia_peptide_wide.tsv", row.names=FALSE, sep="\t", quote = FALSE)

diaPep <- read.csv("dia_peptide_wide.csv")

#Shows IDed peptide counts across conditions
counter(diaPep)

diaPep <- diaPep %>% select(-quant)
ldiaPep <- gather(diaPep, run, intensity, 3:18) %>% filter(!is.na(intensity))
# Filter out those near zero.
ldiaPep <- ldiaPep[which(ldiaPep$intensity > 10), ]

#write.csv(ldiaPep, "dia_peptide_long.csv", row.names = F)

normalyzer(
  jobName="DIA_PeptideNormalization",
  designPath="C:/Users/Logan Wright/DIA_Design_Matrix.txt", 
  dataPath= "C:/Users/Logan Wright/R Scripts/dia_peptide_wide.tsv",
  outputDir="C:/Users/Logan Wright/R Scripts/",
  zeroToNA =TRUE,
  requireReplicates = FALSE)

# Add Normalization identifier column and combine all text files
list_of_files <- list.files(path = "C:/Users/Logan Wright/R Scripts/DIA_PeptideNormalization/", recursive = TRUE,
                            pattern = "\\.txt$", 
                            full.names = TRUE)
DIA_Peptide_Matrix <- rbindlist(sapply(list_of_files, fread, simplify = FALSE),
                use.names = TRUE, idcol = "FileName")

#write.csv(DIA_Peptide_Matrix, "DIA_Peptide_Matrix.csv", row.names = FALSE)
```

```{r DIA Protein Input, echo = FALSE}
dia <- read.csv("EQ_100915_Spectronaut_Protein.csv")
#Rolled up on ms2 - avg
dia <- dia[,c(1,2,4,8)]
names(dia) <- c("condition", "run", "protein", "ms2_avg")
dia$species <- NA
dia[grep("HUMAN", dia$protein), "species"] <- "human"
dia[grep("ECOLI", dia$protein), "species"] <- "ecoli"
# There's ~80 bovine, pig, and keratin hits. These are likely flagged by the 
# database search as common contaminants. 
dia <- dia[which(!is.na(dia$species)), ]

dia$quant <- "dia"
dia$condition <- do.call(paste, c(dia[,c("run", "condition", "quant")], sep = "_"))
dia <- dia[,-2]
diaProt <- spread(dia, condition, ms2_avg)

#write.csv(diaProt, "dia_protein_wide.csv", row.names = F)
#write.table(diaProt, "dia_protein_wide.tsv", row.names=FALSE, sep="\t", quote = FALSE)

diaProt <- read.csv("dia_protein_wide.csv")

#Shows IDed protein counts across conditions
counter(diaProt)
diaProt <- diaProt %>% select(-quant)

ldiaProt <- gather(diaProt, run, intensity, 3:18) %>% filter(!is.na(intensity))
# Filter out those near zero.
ldiaProt <- ldiaProt[which(ldiaProt$intensity > 10), ]

#write.csv(ldiaProt, "dia_protein_long.csv", row.names = F)

normalyzer(
  jobName="DIA_ProteinNormalization", 
  designPath="C:/Users/Logan Wright/DIA_Design_Matrix.txt",
  dataPath="C:/Users/Logan Wright/R Scripts/dia_protein_wide.tsv",
  outputDir="C:/Users/Logan Wright/R Scripts/",
  zeroToNA =TRUE,
  requireReplicates = FALSE)
list_of_files <- list.files(path = "C:/Users/Logan Wright/R Scripts/DIA_ProteinNormalization/", recursive = TRUE,
                            pattern = "\\.txt$", 
                            full.names = TRUE)
DIA_Protein_Matrix <- rbindlist(sapply(list_of_files, fread, simplify = FALSE),
                use.names = TRUE, idcol = "FileName")

#write.csv(DIA_Protein_Matrix, "DIA_Protein_Matrix.csv", row.names = FALSE)
```

```{r DDA Peptide Matrix Spliting, ref.label = "main function", echo = FALSE}

input <- read.csv("DIA_Peptide_Matrix.csv")

input$Normalization <- NA

input[grep("log2", input$FileName), "Normalization"] <- "log2"
input[grep("Cyc", input$FileName), "Normalization"] <- "CycLoess"
input[grep("GI", input$FileName), "Normalization"] <- "Global"
input[grep("mean", input$FileName), "Normalization"] <- "mean"
input[grep("median", input$FileName), "Normalization"] <- "median"
input[grep("Quantile", input$FileName), "Normalization"] <- "Quantile"
input[grep("RLR", input$FileName), "Normalization"] <- "RLR"
input[grep("VSN", input$FileName), "Normalization"] <- "VSN"

#Remove raw data and FileName column
input <- input[which(!is.na(input$Normalization)), ]
input <- input[,-1]

#Call main function for each Normalization and return AUC value and maybe
log2 <- input[which(input$Normalization == "log2"), ]

log <- main(input[which(input$Normalization == "log2"), ], input[1,]$quant)

CycLoess <- main(input[which(input$Normalization == "CycLoess"), ], input[1,]$quant)

Global <- main(input[which(input$Normalization == "Global"), ], input[1,]$quant)

Mean <- main(input[which(input$Normalization == "mean"), ], input[1,]$quant)

Median <- main(input[which(input$Normalization == "median"), ], input[1,]$quant)

Quantile <- main(input[which(input$Normalization == "Quantile"), ], input[1,]$quant)

RLR <- main(input[which(input$Normalization == "RLR"), ], input[1,]$quant)

VSN <- main(input[which(input$Normalization == "VSN"), ], input[1,]$quant)
```

```{r main function, echo = TRUE}
main <- function(input, quant) {
  inputLong <- gather(input, run, intensity, 4:19) %>% filter(!is.na(intensity))
  
  inputLong$condition <- NA
  inputLong[grep("1x", inputLong$run), "condition"] <- "1x"
  inputLong[grep("2x", inputLong$run), "condition"] <- "2x"

  inputLong$quant <- NA
  inputLong[grep("dia", inputLong$run), "quant"] <- "DIA"
  inputLong[grep("dda", inputLong$run), "quant"] <- "DDA"
  
  #protein_counts <- inputLong %>% group_by(quant, condition, species) %>% 
  #summarize(count = length(unique(peptide)))

  #g <- ggplot(protein_counts, aes(x = condition, y = count, fill = species))
  #g <- g + geom_bar(stat = "identity") + facet_grid(. ~ quant)
  #plot(g  + theme_pander(base_size = 19) + scale_fill_economist() + 
  #  theme(text=element_text(size=19,family="serif")) + xlab("E. Coli spike-in ratio") + 
  #  ylab("Peptide count") +  theme(axis.ticks = element_blank()) + 
  #  theme(axis.title.y=element_text(margin=margin(0,20,0,0))) + 
  #  theme(axis.title.x=element_text(margin=margin(20,0,0,0))))
  
      #t-test
      # HU_1x <- inputLong %>% filter(species == "human", condition == "1x") %>%
      # select(intensity) %>% unlist
      # HU_2x <- inputLong %>% filter(species == "human", condition == "2x") %>%
      # select(intensity) %>% unlist
      # 
      # 
      # EC_1x <- inputLong %>% filter(species == "ecoli", condition == "1x") %>%
      # select(intensity) %>% unlist
      # EC_2x <- inputLong %>% filter(species == "ecoli", condition == "2x") %>%
      # select(intensity) %>% unlist
      # 
      # 
      # HU <- t.test(HU_1x, HU_2x)
      # EC <- t.test(EC_1x, EC_2x)
      # 
      # group_means <- inputLong %>% group_by(species, quant, condition) %>% 
      # summarize(mean = mean(intensity)) %>% spread(condition, mean)
      # 
      # names(group_means)[3:4] <- c("1x Mean", "2x Mean")
      # 
      # 
      # overall <- inputLong %>% group_by(species, quant) %>% summarize(count = n()) %>% select(-count)
      # 
      # overall$p.value <- c(EC$p.value, HU$p.value)
      # 
      # overall <- merge(overall, group_means)
      # names(overall)[1:3] <- c("Species", "Quantitation", "P-value")
      # 
      # overall$Ratio <- overall[, "2x Mean"] / overall[, "1x Mean"]
      # 
      # 
      # overall$lower <- NA
      # overall$upper <- NA
      # 
      # HU_ratio <- ttestratio(HU_2x, HU_1x)
      # EC_ratio <- ttestratio(EC_2x, EC_1x)
      # 
      # overall[1, "lower"] <- EC_ratio$conf.int[[1]]
      # overall[1, "upper"] <- EC_ratio$conf.int[[2]]
      # 
      # 
      # overall[2, "lower"] <- HU_ratio$conf.int[[1]]
      # overall[2, "upper"] <- HU_ratio$conf.int[[2]]
      # 
      # overall$expected_ratio <- c(2,1)
      # 
      # g <- ggplot(overall, aes(x = Quantitation, y = log2(Ratio)))
      # plot(g + geom_point(size = 2) + facet_grid(. ~ Species) + 
      # geom_errorbar(aes(x = Quantitation, ymax = log2(upper), ymin = log2(lower)), 
      # width = 0.2) + 
      # geom_point(aes(x = Quantitation, y = log2(expected_ratio)), colour = "blue", size = 3) +
      # theme_pander(base_size = 19) + scale_colour_economist() +
      # theme(text=element_text(size=19,family="serif")) +
      # theme(axis.ticks = element_blank()) + 
      # theme(axis.title.y=element_text(margin=margin(0,20,0,0))) + 
      # theme(axis.title.x=element_text(margin=margin(20,0,0,0))) + 
      # labs(y=expression(Log[2]*Ratio), x = "") + 
      # scale_y_continuous(breaks=seq(-0.2,1.0,0.2)))
      # 
      # 
      # overall <- overall %>% select(-expected_ratio)
      # overall
      # 
  ttest_data <- inputLong %>% group_by(species, quant, peptide) %>% do(
    ttest = {
      one <- .[which(.[,"condition"] == "1x"),]
      one <- one$intensity
      
      two <- .[which(.[,"condition"] == "2x"),]
      two <- two$intensity
      
      if(length(one) > 1 && length(two) > 1) {
        data_ratio <- ttestratio(two, one)
        
        lower <- data_ratio$conf.int[[1]]
        upper <- data_ratio$conf.int[[2]]
        ratio <- data_ratio$estimate[[3]]
        pratio <- data_ratio$p.value[[1]]
    
        paste(ratio, pratio, lower, upper, sep = " ")
      
        }
      
      else(NA) 
      
      }
    )
  
  ttest_data <- ttest_data %>% filter(!is.na(ttest)) %>% 
    separate(ttest, c("ratio", "p.value", "lower", "upper"), " ", convert = TRUE)
  
  ttest_data <- ttest_data %>% filter(!is.na(upper), !is.na(lower), !is.na(p.value)) 
  
  #P value Confusion Matrix
  confusionPTable <- data.frame("key" = character(0), "value" = numeric(0))

  # True positives DDA
  confusionPTable[1,1] <- "True positives"
  confusionPTable[1,2] <-  nrow(ttest_data %>% filter(species == "ecoli", p.value < 0.05))
  
  
  # False negatives DDA
  confusionPTable[2,1] <- "False negatives"
  confusionPTable[2,2] <-  nrow(ttest_data %>% filter(species == "ecoli", p.value >= 0.05))
  
  # False positives DDA
  confusionPTable[3,1] <- "False positives"
  confusionPTable[3,2] <-   nrow(ttest_data %>% filter(species == "human", p.value < 0.05))
  
  
  # True negatives DDA
  confusionPTable[4,1] <- "True negatives"
  confusionPTable[4,2] <-   nrow(ttest_data %>% filter(species == "human", p.value >= 0.05))
  
  # E. Coli proteins
  confusionPTable[5,1] <- "Condition positive"
  confusionPTable[5,2] <- nrow(ttest_data %>% filter(species == "ecoli"))
  
  # Human proteins
  confusionPTable[6,1] <- "Condition negative"
  confusionPTable[6,2] <- nrow(ttest_data %>% filter(species == "human"))
  
  # P < 0.05
  confusionPTable[7,1] <- "Predicted condition positive"
  confusionPTable[7,2] <- nrow(ttest_data %>% filter(p.value < 0.05))
  
  # P >= 0.05
  confusionPTable[8,1] <- "Predicted condition negative"
  confusionPTable[8,2] <- nrow(ttest_data %>% filter(p.value >= 0.05))
  
  # Total population
  confusionPTable[9,1] <- "Total population"
  confusionPTable[9,2] <- nrow(ttest_data)
  
  # Accuracy
  confusionPTable[10,1] <- "Accuracy"
  confusionPTable[10,2] <- (confusionPTable[1,2] + confusionPTable[4,2]) / confusionPTable[9,2]
  
  # Prevalence
  confusionPTable[11,1] <- "Prevalence"
  confusionPTable[11,2] <- confusionPTable[5,2] / confusionPTable[9,2]
  
  # False positive rate
  confusionPTable[12,1] <- "False positive rate"
  confusionPTable[12,2] <- confusionPTable[3,2] / confusionPTable[6,2]
  
  # True positive rate
  confusionPTable[13,1] <- "True positive rate"
  confusionPTable[13,2] <- confusionPTable[1,2] / confusionPTable[5,2]
  
  # False negative rate
  confusionPTable[14,1] <- "False negative rate"
  confusionPTable[14,2] <- confusionPTable[2,2] / confusionPTable[5,2]
  
  # True negative rate
  confusionPTable[15,1] <- "True negative rate"
  confusionPTable[15,2] <- confusionPTable[4,2] / confusionPTable[6,2]
  
  #Q-test
  q <- qvalue(p = ttest_data$p.value)
  # plot(q_DDA)
  # hist(q_DDA)
  # summary(q_DDA)
  ttest_data$q.value <- q$qvalues
  
  #Q-value confusion matrix
  confusionQTable <- data.frame("key" = character(0), "value" = numeric(0))

  # True positives DDA
  confusionQTable[1,1] <- "True positives"
  confusionQTable[1,2] <- 
    nrow(ttest_data %>% filter(species == "ecoli", q.value < 0.05))
  
  
  # False negatives DDA
  confusionQTable[2,1] <- "False negatives"
  confusionQTable[2,2] <-
    nrow(ttest_data %>% filter(species == "ecoli", q.value >= 0.05))
  
  # False positives DDA
  confusionQTable[3,1] <- "False positives"
  confusionQTable[3,2] <- 
    nrow(ttest_data %>% filter(species == "human", q.value < 0.05))
  
  
  # True negatives DDA
  confusionQTable[4,1] <- "True negatives"
  confusionQTable[4,2] <- 
    nrow(ttest_data %>% filter(species == "human", q.value >= 0.05))
  
  # E. Coli proteins
  confusionQTable[5,1] <- "Condition positive"
  confusionQTable[5,2] <- nrow(ttest_data %>% filter(species == "ecoli"))
  
  # Human proteins
  confusionQTable[6,1] <- "Condition negative"
  confusionQTable[6,2] <- nrow(ttest_data %>% filter(species == "human"))
  
  # P < 0.05
  confusionQTable[7,1] <- "Predicted condition positive"
  confusionQTable[7,2] <- nrow(ttest_data %>% filter(q.value < 0.05))
  
  # P >= 0.05
  confusionQTable[8,1] <- "Predicted condition negative"
  confusionQTable[8,2] <- nrow(ttest_data %>% filter(q.value >= 0.05))
  
  # Total population
  confusionQTable[9,1] <- "Total population"
  confusionQTable[9,2] <- nrow(ttest_data)
  
  # Accuracy
  confusionQTable[10,1] <- "Accuracy"
  confusionQTable[10,2] <- (confusionQTable[1,2] + confusionQTable[4,2]) / confusionQTable[9,2]
  
  # Prevalence
  confusionQTable[11,1] <- "Prevalence"
  confusionQTable[11,2] <- confusionQTable[5,2] / confusionQTable[9,2]
  
  # False positive rate
  confusionQTable[12,1] <- "False positive rate"
  confusionQTable[12,2] <- confusionQTable[3,2] / confusionQTable[6,2]
  
  # True positive rate
  confusionQTable[13,1] <- "True positive rate"
  confusionQTable[13,2] <- confusionQTable[1,2] / confusionQTable[5,2]
  
  # False negative rate
  confusionQTable[14,1] <- "False negative rate"
  confusionQTable[14,2] <- confusionQTable[2,2] / confusionQTable[5,2]
  
  # True negative rate
  confusionQTable[15,1] <- "True negative rate"
  confusionQTable[15,2] <- confusionQTable[4,2] / confusionQTable[6,2]
  
  #Won't work anymore
  confusionTable <- merge(confusionPTable, confusionQTable)
  tab <- "q-value Confusion Table"
  #knitr::kable(confusionPTable, caption = "log2 p-value confusion table", digits = 2)
  print(knitr::kable(confusionQTable, caption = paste(input[1,]$Normalization, tab, sep = " "), digits = 2))
  
  #Generate ROC curve
  ttest_data$changing <- TRUE
  ttest_data[which(ttest_data$species == "human"), "changing"] <- FALSE
  
  max(ttest_data$q.value)
  x <- seq(0.0, 1.0, 0.01)
  
  fpr <- c()
  tpr <- c()
  
  cp <- length(which(ttest_data$changing))
  cn <- length(which(!ttest_data$changing))
  for(i in 1:length(x)) {
    ttest_data$test <- FALSE
    ttest_data[which(ttest_data$q.value < x[i]),"test"] <- TRUE
    
    tpr[i] <- length(which(ttest_data$changing & ttest_data$test)) / cp
    fpr[i] <- length(which(!ttest_data$changing & ttest_data$test)) / cn
  }
  
  data_roc <- data.frame("threshold" = x, "tpr" = tpr, "fpr" = fpr)
  
  g  <- ggplot(data_roc, aes(x = fpr, y = tpr, colour = threshold))
  roc <- plot(g + geom_point() + geom_line() + 
    theme_pander(base_size = 19) + scale_fill_economist() +
    theme(text=element_text(size=19,family="serif")) +
    theme(axis.ticks = element_blank()) + 
    theme(axis.title.y=element_text(margin=margin(0,20,0,0))) + 
    theme(axis.title.x=element_text(margin=margin(20,0,0,0))) + 
    labs(x="False positive rate", y = "True positive rate") + 
    ggtitle(paste(input[1,]$Normalization)))
  
  height = (tpr[-1]+tpr[-length(tpr)])/2
  width = diff(fpr)
  
  AUC <- sum(height*width)
  return(list(AUC, roc))
}

```

```{r Protein/Peptide Counts, echo = FALSE}
 counter <- function(input) {
  inputLong <- gather(input, run, intensity, 4:19) %>% filter(!is.na(intensity))
  dat <- colnames(input)[1]
  inputLong$condition <- NA
  inputLong[grep("1x", inputLong$run), "condition"] <- "1x"
  inputLong[grep("2x", inputLong$run), "condition"] <- "2x"

  inputLong$quant <- NA
  inputLong[grep("dia", inputLong$run), "quant"] <- "DIA"
  inputLong[grep("dda", inputLong$run), "quant"] <- "DDA"
  protein_counts <- inputLong %>% group_by(quant, condition, species) %>% 
    summarize(count = length(unique(peptide)))
  
    g <- ggplot(protein_counts, aes(x = condition, y = count, fill = species))
    g <- g + geom_bar(stat = "identity") + facet_grid(. ~ quant)
    ret <- plot(g  + theme_pander(base_size = 19) + scale_fill_economist() + 
      theme(text=element_text(size=19,family="serif")) + xlab("E. Coli spike-in ratio") + 
      ylab(paste(dat)) +  theme(axis.ticks = element_blank()) + 
      theme(axis.title.y=element_text(margin=margin(0,20,0,0))) + 
      theme(axis.title.x=element_text(margin=margin(20,0,0,0))))
 }


```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

