---
title: "BenchmarkingFinal"
author: "Lgan Wright"
date: "July 15, 2019"
output: pdf_document
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
options(stringsAsFactors = F)
options(scipen=999)
options(digits=8)
library("RforProteomics")
library("plyr")
library('MSstats', warn.conflicts = F, quietly = T, verbose = F)
#library("knitr")
#library("foreach")
library("genefilter")
library(ROTS); library(data.table);
library(SpikeInSubset); library(limma); library(PECA); library(readxl); 
library(dplyr); library(tidyr); library(ggplot2); library(ggthemes); 
library(printr); library(mratios); library(extrafont); library(qvalue); library(cowplot);
library(grid); library(gridExtra); library(data.table); library(DEqMS); library(gtable)
knitr::opts_chunk$set(echo = TRUE)

#install.packages("gtable")
#BiocManager::install("DEqMS", dependencies = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r sum normalization function, echo = FALSE}
sumNorm <- function(diaProt, index) {
 #Normalization
tot = 0
ecoliRow <- diaProt[which(diaProt$species == "ecoli"), ]
diaProt <- diaProt[which(diaProt$species == "human"), ]
for (i in index:length(colnames(diaProt))) {
  for (j in 1:length(diaProt[,i])) {
    if(is.na(diaProt[j,i])) {
      next
    }
    tot <- tot + diaProt[j,i]
  }
  if (i ==index) {
    group1 <- tot
  }
  fact <- tot/group1
  for (j in 1:length(diaProt[,i])) {
     if(is.na(diaProt[j,i])) {
      next
    }
    diaProt[j,i] <- diaProt[j,i]/fact
  }
  for(j in 1:length(ecoliRow[,i])) {
    if(is.na(ecoliRow[j,i])) {
      next
    }
    ecoliRow[j,i] <- ecoliRow[j,i]/fact
  }
  tot = 0
}
diaProt <- rbind(diaProt, ecoliRow)
return(diaProt)
}
```

```{r DDA Peptide Input, echo = FALSE}
conditions <- read.csv("annotation.csv")
conditions <- conditions[,1:2]
names(conditions) <- c("run", "condition")


dda <- read.csv("peptides.csv")
dda <- dda[, c(1, 37, grep("Intensity", names(dda)))]
names(dda)[4:19] <- unlist(lapply(names(dda)[4:19], function(x) {
  unlist(strsplit(x, "\\."))[1]
}))
dda <- dda[,-3]
dda <- gather(dda, run, intensity, 3:18, convert = TRUE, factor_key = TRUE)
dda$run <- as.character(dda$run)
dda <- merge(dda, conditions)
rm(conditions)

names(dda)[2] <- "peptide"

dda$quant <- "dda"
dda$condition <- do.call(paste, c(dda[,c("run", "condition", "quant")], sep = "_"))
dda <- dda[,-1]

dda$species <- NA
dda[grep("HUMAN", dda$Species), "species"] <- "human"
dda[grep("ECOLI", dda$Species), "species"] <- "ecoli"
dda <- dda[which(!is.na(dda$species)), ]
dda <- dda[,-2]
dda <- dda[which(dda$intensity != 0), ]

# There are only six duplicate quants for proteins in the same run. I'm 
# unsure why MaxQuant is doing this. Perhaps it is for a different modification 
# state of that protein? There are very few, so I will just remove the
# duplicates. 
dda <- dda[which(!duplicated(dda[ , c("peptide", "condition", "species")])), ]

ddaPep <- spread(dda, condition, intensity)
ddaPepR4 <- ddaPep[,-12:-19]
ddaPep <- sumNorm(ddaPep, 4)
ddaPepR4 <-sumNorm(ddaPepR4, 4)

#write.csv(ddaPep, "dda_peptide_wide.csv", row.names = F)
#write.csv(ddaPepR4, "dda_peptide_wide_R4.csv", row.names = F)
#ddaPep <- read.csv("dda_peptide_wide.csv")

#Shows IDed peptide counts across conditions
counter(ddaPep)

ddaPep <- ddaPep %>% select(-quant)

lddaPep <- gather(ddaPep, run, intensity, 3:18) %>% filter(!is.na(intensity))


ddaPepR4 <- ddaPepR4 %>% select(-quant)

lddaPepR4 <- gather(ddaPepR4, run, intensity, 3:10) %>% filter(!is.na(intensity))

#write.csv(lddaPep, "dda_peptide_long.csv", row.names = F)
#write.csv(lddaPepR4, "dda_peptide_long_R4.csv", row.names = F)

# out_dir = "C:/Users/Logan Wright/R Scripts/NormalyzerOutput/"
# normalyzer(
#   jobName="DDA_PeptideNormalization",
#   designPath="C:/Users/Logan Wright/DDA_Design_Matrix.txt", 
#   dataPath= "C:/Users/Logan Wright/R Scripts/dda_peptide_wide.tsv",
#   outputDir= out_dir,
#   zeroToNA =TRUE,
#   requireReplicates = FALSE)

# Add Normalization identifier column and combine all text files
# list_of_files <- list.files(path = "C:/Users/Logan Wright/R Scripts/NormalyzerOutput/DDA_PeptideNormalization/", recursive = TRUE,
#                             pattern = "\\.txt$", 
#                             full.names = TRUE)
# DDA_Peptide_Matrix <- rbindlist(sapply(list_of_files, fread, simplify = FALSE),
#                 use.names = TRUE, idcol = "FileName")

#write.csv(DDA_Peptide_Matrix, "DDA_Peptide_Matrix.csv", row.names = FALSE)
```

```{r DDA Protein Input, echo = FALSE}
conditions <- read.csv("annotation.csv")
conditions <- conditions[,1:2]
names(conditions) <- c("run", "condition")


dda <- read.csv("proteinGroups.csv")
dda <- dda[, c(6, grep("Intensity.", names(dda)))]
names(dda)[2:17] <- unlist(lapply(names(dda)[2:17], function(x) {
  unlist(strsplit(x, "\\."))[3]
}))
nam <- paste(conditions[,1], conditions[,2], sep="_")
names(dda)[2:17] <- nam
rm(conditions)

names(dda)[1] <- "protein"
dda$quant <- "dda"
dda$species <- NA
dda[grep("HUMAN", dda$protein), "species"] <- "human"
dda[grep("ECOLI", dda$protein), "species"] <- "ecoli"
dda <- dda[which(!is.na(dda$species)), ]

# There are only three duplicate quants for proteins in the same run. I'm 
# unsure why MaxQuant is doing this. Perhaps it is for a different modification 
# state of that protein? There are very few, so I will just remove the
# duplicates. 
dda <- dda[which(!duplicated(dda[ , c("protein", "species")])), ]

ddaProt <- dda[,c(1,19,18,2:17)]
ddaProt[ddaProt==0] <-NA

ddaProtR4 <- ddaProt[,-12:-19]
ddaProt <- sumNorm(ddaProt, 4)
ddaProtR4 <- sumNorm(ddaProtR4, 4)
#write.csv(ddaProt, "dda_protein_wide.csv", row.names = F)
#write.csv(ddaProtR4, "dda_protein_wide_R4.csv", row.names=F)
#ddaProt <- read.csv("dda_protein_wide.csv")

#Shows IDed protein counts across conditions
counter(ddaProt)

ddaProt <- ddaProt %>% select(-quant)

lddaProt <- gather(ddaProt, run, intensity, 3:18) %>% filter(!is.na(intensity))

ddaProtR4 <- ddaProtR4 %>% select(-quant)

lddaProtR4 <- gather(ddaProtR4, run, intensity, 3:10) %>% filter(!is.na(intensity))

#write.csv(lddaProt, "dda_protein_long.csv", row.names = F)
#write.csv(lddaProtR4, "dda_protein_long_R4.csv", row.names = F)

# normalyzer(
#   jobName="DDA_ProteinNormalization", 
#   designPath="C:/Users/Logan Wright/DDA_Design_Matrix.txt",
#   dataPath="C:/Users/Logan Wright/R Scripts/dda_protein_wide.tsv",
#   outputDir="C:/Users/Logan Wright/R Scripts/",
#   zeroToNA =TRUE,
#   requireReplicates = FALSE)
# list_of_files <- list.files(path = "C:/Users/Logan Wright/R Scripts/DDA_ProteinNormalization/", recursive = TRUE,
#                             pattern = "\\.txt$", 
#                             full.names = TRUE)
# DDA_Protein_Matrix <- rbindlist(sapply(list_of_files, fread, simplify = FALSE),
#                 use.names = TRUE, idcol = "FileName")

#write.csv(DDA_Protein_Matrix, "DDA_Protein_Matrix.csv", row.names = FALSE)
```

```{r DIA Peptide Input, echo = FALSE}
dia <- read.csv("20190617_122759_EA100915_Benchmarkv2_Report.csv")
#Rolled up on ms2 - avg
dia <- dia[,c(1,2,6,7,11)]
names(dia) <- c("condition", "run", "protein", "peptide", "ms2_peak")

# for(i in 1:length(dia$ms2_peak)) {
#   if (dia[i,]$ms2_peak < 1) {
#    dia[i,]$ms2_peak = 0
#   }
# }

dia$species <- NA
dia[grep("HUMAN", dia$protein), "species"] <- "human"
dia[grep("ECOLI", dia$protein), "species"] <- "ecoli"
# There's ~80 bovine, pig, and keratin hits. These are likely flagged by the
# database search as common contaminants.
dia <- dia[which(!is.na(dia$species)), ]

dia$quant <- "dia"
dia$condition <- do.call(paste, c(dia[,c("run", "condition", "quant")], sep = "_"))
dia <- dia[,-2]
#Remove duplicates
dia <- dia[which(!duplicated(dia[ , c("peptide", "condition", "species")])), ]
dia <- dia[which(dia$ms2_peak > 1), ]

diaPep <- spread(dia, condition, ms2_peak)
diaPepR4 <- diaPep[,-13:-20]

diaPep <- sumNorm(diaPep, 5)
diaPepR4 <- sumNorm(diaPepR4, 5)
#write.csv(diaPep, "dia_peptide_wide.csv", row.names = F)
#write.csv(diaPepR4, "dia_peptide_wide_R4.csv", row.names=F)
#diaPep <- read.csv("dia_peptide_wide.csv")

#Shows IDed peptide counts across conditions
counter(diaPep)

diaPep <- diaPep %>% select(-quant)
ldiaPep <- gather(diaPep, run, intensity, 4:19) %>% filter(!is.na(intensity))

diaPepR4 <- diaPepR4 %>% select(-quant)

ldiaPepR4 <- gather(diaPepR4, run, intensity, 4:11) %>% filter(!is.na(intensity))

#write.csv(ldiaPep, "dia_peptide_long.csv", row.names = F)
#write.csv(ldiaPepR4, "dia_peptide_long_R4.csv", row.names = F)

# normalyzer(
#   jobName="DIA_PeptideNormalization",
#   designPath="C:/Users/Logan Wright/DIA_Design_Matrix.txt",
#   dataPath= "C:/Users/Logan Wright/R Scripts/dia_peptide_wide.tsv",
#   outputDir="C:/Users/Logan Wright/R Scripts/",
#   zeroToNA =TRUE,
#   requireReplicates = FALSE)
# 
# # Add Normalization identifier column and combine all text files
# list_of_files <- list.files(path = "C:/Users/Logan Wright/R Scripts/DIA_PeptideNormalization/", recursive = TRUE,
#                             pattern = "\\.txt$",
#                             full.names = TRUE)
# DIA_Peptide_Matrix <- rbindlist(sapply(list_of_files, fread, simplify = FALSE),
#                 use.names = TRUE, idcol = "FileName")

#write.csv(DIA_Peptide_Matrix, "DIA_Peptide_Matrix.csv", row.names = FALSE)
```

```{r DIA Protein Input, echo = FALSE}
dia <- read.csv("20190617_122759_EA100915_Benchmarkv2_Report.csv")
#Rolled up on ms2 - avg
dia <- dia[,c(1,2,6,7,11)]
names(dia) <- c("condition", "run", "protein","peptide", "ms2_Total")

dia$species <- NA
dia[grep("HUMAN", dia$protein), "species"] <- "human"
dia[grep("ECOLI", dia$protein), "species"] <- "ecoli"
# There's ~80 bovine, pig, and keratin hits. These are likely flagged by the 
# database search as common contaminants. 
dia <- dia[which(!is.na(dia$species)), ]

dia$quant <- "dia"
dia$condition <- do.call(paste, c(dia[,c("run", "condition", "quant")], sep = "_"))
dia <- dia[,-2]
dia <- ddply(dia, .(protein,condition), numcolwise(mean,na.rm=TRUE))
dia$quant <- "dia"
dia$species <- NA
dia[grep("HUMAN", dia$protein), "species"] <- "human"
dia[grep("ECOLI", dia$protein), "species"] <- "ecoli"

dia <- dia[which(dia$ms2_Total != 0), ]
diaProt <- spread(dia, condition, ms2_Total)
diaProtR4 <- diaProt[,-12:-19]

diaProt <- sumNorm(diaProt, 4)
diaProtR4 <- sumNorm(diaProtR4, 4)
#write.csv(diaProt, "dia_protein_wide.csv", row.names = F)
#write.csv(diaProtR4, "dia_protein_wide_R4.csv", row.names=F)
#diaProt <- read.csv("dia_protein_wide.csv")

diaProt <- diaProt %>% select(-quant)

ldiaProt <- gather(diaProt, run, intensity, 3:18) %>% filter(!is.na(intensity))

#write.csv(ldiaProt, "dia_protein_long.csv", row.names = F)

diaProtR4 <- diaProtR4 %>% select(-quant)

ldiaProtR4 <- gather(diaProtR4, run, intensity, 3:10) %>% filter(!is.na(intensity))


#write.csv(ldiaProtR4, "dia_protein_long_R4.csv", row.names = F)

# normalyzer(
#   jobName="DIA_ProteinNormalization_ms2Sum", 
#   designPath="C:/Users/Logan Wright/DIA_Design_Matrix.txt",
#   dataPath="C:/Users/Logan Wright/R Scripts/dia_protein_wide_sum.tsv",
#   outputDir="C:/Users/Logan Wright/R Scripts/",
#   zeroToNA =TRUE,
#   requireReplicates = FALSE)
# list_of_files <- list.files(path = "C:/Users/Logan Wright/R Scripts/DIA_ProteinNormalization_ms2Sum/", recursive = TRUE,
#                             pattern = "\\.txt$", 
#                             full.names = TRUE)
# DIA_Protein_Matrix <- rbindlist(sapply(list_of_files, fread, simplify = FALSE),
#                 use.names = TRUE, idcol = "FileName")

#write.csv(DIA_Protein_Matrix, "DIA_Protein_Matrix_ms2Sum.csv", row.names = FALSE)
```

```{r Matrix Spliting, ref.label = "main function", echo = FALSE}

input <- read.csv("DDA_Peptide_Matrix.csv")

#Remove raw data and FileName column
# input <- input[which(!is.na(input$Normalization)), ]
# input <- input[,-1]

#par(mfrow = c(1,7))
#Call main function for each Normalization and return AUC value and roc curve


pdf(file = "DIA_09_10_19.pdf")

input <- read.csv("dia_protein_wide.csv")
out1 <- main(input, input$quant[1], length(colnames(input)), 0.05)

input <- read.csv("dia_protein_wide_R4.csv")
out2 <- main(input, input$quant[1], length(colnames(input)), 0.05)

input <- read.csv("dia_peptide_wide.csv")
out3 <- main(input, input$quant[1], length(colnames(input)), 0.05)

input <- read.csv("dia_peptide_wide_R4.csv")
out4 <- main(input, input$quant[1], length(colnames(input)), 0.05)

dev.off




log <- main(input[which(input$Normalization == "log2"), ], input[1,]$quant)

CycLoess <- main(input[which(input$Normalization == "CycLoess"), ], input[1,]$quant)

Global <- main(input[which(input$Normalization == "Global"), ], input[1,]$quant)

Mean <- main(input[which(input$Normalization == "mean"), ], input[1,]$quant)

Median <- main(input[which(input$Normalization == "median"), ], input[1,]$quant)

Quantile <- main(input[which(input$Normalization == "Quantile"), ], input[1,]$quant)

RLR <- main(input[which(input$Normalization == "RLR"), ], input[1,]$quant)

VSN <- main(input[which(input$Normalization == "VSN"), ], input[1,]$quant)

input <-  input[which(input$Normalization == "log2"), ]




log[[5]]
log[[7]]
CycLoess[[5]]
CycLoess[[7]]
Global[[5]]
Global[[7]]
#Quantile[[5]]
#Quantile[[7]]
Mean[[5]]
Mean[[7]]
Median[[5]]
Median[[7]]
RLR[[5]]
RLR[[7]]
VSN[[5]]
VSN[[7]]

VSN[[3]]



VSN_rocGrob <- ggplotGrob(VSN[[5]][[1]])
RLR_rocGrob <- ggplotGrob(RLR[[5]][[1]])
grobList <- list(VSN_rocGrob, RLR_rocGrob)
help(gtable_matrix)
gtable_matrix("name", grobList, widths = list(2), heights = list(1))




# logRot <- rotTest(input[which(input$Normalization == "log2"), ], input[1,]$quant)
# 
# CycLoessRot <- rotTest(input[which(input$Normalization == "CycLoess"), ], input[1,]$quant)
# 
# GlobalRot <- rotTest(input[which(input$Normalization == "Global"), ], input[1,]$quant)
# 
# MeanRot <- rotTest(input[which(input$Normalization == "mean"), ], input[1,]$quant)
# 
# MedianRot <- rotTest(input[which(input$Normalization == "median"), ], input[1,]$quant)
# 
# QuantileRot <- rotTest(input[which(input$Normalization == "Quantile"), ], input[1,]$quant)
# 
# RLRRot <- rotTest(input[which(input$Normalization == "RLR"), ], input[1,]$quant)
# 
# VSNRot <- rotTest(input[which(input$Normalization == "VSN"), ], input[1,]$quant)

write.csv(log[[3]], "log2_modt_output.csv", row.names = TRUE)
write.csv(Mean[[3]], "Mean_modt_output.csv", row.names = TRUE)
write.csv(Median[[3]], "Median_modt_output.csv", row.names = TRUE)
write.csv(Global[[3]], "Global_modt_output.csv", row.names = TRUE)
write.csv(Quantile[[3]], "Quantile_modt_output.csv", row.names = TRUE)
write.csv(CycLoess[[3]], "CycLoess_modt_output.csv", row.names = TRUE)
write.csv(RLR[[3]], "RLR_modt_output.csv", row.names = TRUE)
write.csv(VSN[[3]], "VSN_modt_output.csv", row.names = TRUE)

t1 <- read.csv("DIA_Peptide_ROPECA/CycLoess_ROPECA_output.csv")
ropecaConfusion(t1, "CycLoess")
t1 <- read.csv("DIA_Peptide_ROPECA/log2_ROPECA_output.csv")
ropecaConfusion(t1, "log2")
t1 <- read.csv("DIA_Peptide_ROPECA/Mean_ROPECA_output.csv")
ropecaConfusion(t1, "Mean")
t1 <- read.csv("DIA_Peptide_ROPECA/Median_ROPECA_output.csv")
ropecaConfusion(t1, "Median")
t1 <- read.csv("DIA_Peptide_ROPECA/Global_ROPECA_output.csv")
ropecaConfusion(t1, "Global")
t1 <- read.csv("DIA_Peptide_ROPECA/RLR_ROPECA_output.csv")
ropecaConfusion(t1, "RLR")
t1 <- read.csv("DIA_Peptide_ROPECA/VSN_ROPECA_output.csv")
ropecaConfusion(t1, "VSN")
t1 <- read.csv("DIA_Peptide_ROPECA/Quantile_ROPECA_output.csv")
ropecaConfusion(t1, "Quantile")

rotsVis(VSN[[2]], 0.05)
# group1 = c("EA100915_05_1x_dia", "EA100915_09_1x_dia", "EA100915_13_1x_dia", "EA100915_21_1x_dia", "EA100915_25_1x_dia", "EA100915_29_1x_dia", "EA100915_33_1x_dia", "EA100915_41_1x_dia")
# 
# group2 = c("EA100915_06_2x_dia", "EA100915_10_2x_dia", "EA100915_14_2x_dia", "EA100915_18_2x_dia", "EA100915_26_2x_dia", "EA100915_30_2x_dia", "EA100915_34_2x_dia", "EA100915_38_2x_dia")


# layout(matrix(c(1,2,3,4,5,6,7,8), nrow = 1, ncol = 8, byrow = TRUE))
# 
# plot(log[[2]], main = 1)
# plot(CycLoess[[2]]
# plot(Quantile[[2]])
# plot(RLR[[2]])
# plot(VSN[[2]]), main = 2)
# plot(Global[[2]])
# plot(Mean[[2]])
# plot(Median[[2]])

#Visualization Code
#grid.arrange(as.grob(log[[2]]), as.grob(CycLoess[[2]]), as.grob(Global[[2]]), as.grob(Mean[[2]]), as.grob(Median[[2]]), as.grob(RLR[[2]]), as.grob(VSN[[2]]), nrow=1)

#grid.arrange(log[[2]], (CycLoess[[2]]),(Global[[2]]), (Mean[[2]]), (Median[[2]]), (RLR[[2]]), (VSN[[2]]), widths = c(1,1,1,1,1,1,1), ncol=7, layout_matrix = rbind(c(1,1,1,1,1,1,1),
#                                                 c(2,2,2,2,2,2,2),
#                                                 c(3,3,3,3,3,3,3),
#                                                 c(4,4,4,4,4,4,4),
#                                                 c(5,5,5,5,5,5,5),
#                                                 c(6,6,6,6,6,6,6),
#                                                 c(7,7,7,7,7,7,7)))

summary(log[[2]], fdr = 0.05)
#plot_grid(log[[2]], (CycLoess[[2]]),(Global[[2]]), (Mean[[2]]), (Median[[2]]), (RLR[[2]]), (VSN[[2]]), align = "v",ncol = 7, nrow = 1, rel_heights = c(1/16, 1/16, 1/16, 1/16, 1/16, 1/16, 1/16))

```



```{r main function, echo = TRUE}
main <- function(input, quant, cols, fdr) {
  
  inputLong <- gather(input, run, intensity, 4:cols) %>% filter(!is.na(intensity))
  
  inputLong$condition <- NA
  inputLong[grep("1x", inputLong$run), "condition"] <- "1x"
  inputLong[grep("2x", inputLong$run), "condition"] <- "2x"

  inputLong$quant <- NA
  inputLong[grep("dia", inputLong$run), "quant"] <- "DIA"
  inputLong[grep("dda", inputLong$run), "quant"] <- "DDA"
  
  if (colnames(input)[1] == "protein")   {    
    protein_counts <- inputLong %>% group_by(quant, condition, species) %>%
    summarize(count = length(unique(protein)))
  }
  
  if (colnames(input)[1] == "peptide")   {    
    protein_counts <- inputLong %>% group_by(quant, condition, species) %>%
    summarize(count = length(unique(peptide)))
  }

  #g <- ggplot(protein_counts, aes(x = condition, y = count, fill = species))
  #g <- g + geom_bar(stat = "identity") + facet_grid(. ~ quant)
  #plot(g  + theme_pander(base_size = 19) + scale_fill_economist() +
  #  theme(text=element_text(size=19,family="serif")) + xlab("E. Coli spike-in ratio") +
  #  ylab("Peptide count") +  theme(axis.ticks = element_blank()) +
  #  theme(axis.title.y=element_text(margin=margin(0,20,0,0))) +
  #  theme(axis.title.x=element_text(margin=margin(20,0,0,0))))

      #t-test
       HU_1x <- inputLong %>% filter(species == "human", condition == "1x") %>%
       select(intensity) %>% unlist
       HU_2x <- inputLong %>% filter(species == "human", condition == "2x") %>%
       select(intensity) %>% unlist
      
       EC_1x <- inputLong %>% filter(species == "ecoli", condition == "1x") %>%
       select(intensity) %>% unlist
       EC_2x <- inputLong %>% filter(species == "ecoli", condition == "2x") %>%
       select(intensity) %>% unlist
      
       HU <- t.test(x=HU_1x, y=HU_2x)
       EC <- t.test(x=EC_1x, y=EC_2x)
      
       group_means <- inputLong %>% group_by(species, quant, condition) %>%
       summarize(mean = mean(intensity)) %>% spread(condition, mean)
      
       names(group_means)[3:4] <- c("1x Mean", "2x Mean")
      
      
       overall <- inputLong %>% group_by(species, quant) %>% summarize(count = n()) %>% select(-count)
      
       overall$p.value <- c(EC$p.value, HU$p.value)
      
       overall <- merge(overall, group_means)
       names(overall)[1:3] <- c("Species", "Quantitation", "P-value")
      
       overall$Ratio <- overall[, "2x Mean"] / overall[, "1x Mean"]
      
      
       overall$lower <- NA
       overall$upper <- NA
      
       HU_ratio <- ttestratio(HU_2x, HU_1x)
       EC_ratio <- ttestratio(EC_2x, EC_1x)
      
       overall[1, "lower"] <- EC_ratio$conf.int[[1]]
       overall[1, "upper"] <- EC_ratio$conf.int[[2]]
      
      
       overall[2, "lower"] <- HU_ratio$conf.int[[1]]
       overall[2, "upper"] <- HU_ratio$conf.int[[2]]
      
       overall$expected_ratio <- c(2,1)
      
      g <- ggplot(overall, aes(x = Quantitation, y = log2(Ratio)))
      plot(g + geom_point(size = 2) + facet_grid(. ~ Species) +
      geom_errorbar(aes(x = Quantitation, ymax = log2(upper), ymin = log2(lower)),
      width = 0.2) +
      geom_point(aes(x = Quantitation, y = log2(expected_ratio)), colour = "blue", size = 3) +
      theme_pander(base_size = 19) + scale_colour_economist() +
      theme(text=element_text(size=19,family="serif")) +
      theme(axis.ticks = element_blank()) +
      theme(axis.title.y=element_text(margin=margin(0,20,0,0))) +
      theme(axis.title.x=element_text(margin=margin(20,0,0,0))) +
      labs(y=expression(Log[2]*Ratio), x = "") +
      scale_y_continuous(breaks=seq(-0.2,1.0,0.2)))

      overall <- overall %>% select(-expected_ratio)
      overall

   if (colnames(input)[1] == "protein")   {    
     ttest_data <- inputLong %>% group_by(species, quant, protein) %>% do(
       ttest = {
         one <- .[which(.[,"condition"] == "1x"),]
         one <- one$intensity
         
         two <- .[which(.[,"condition"] == "2x"),]
         two <- two$intensity
         
         if(length(one) > 1 && length(two) > 1) {
           data_ratio <- ttestratio(two, one)
           
           lower <- data_ratio$conf.int[[1]]
           upper <- data_ratio$conf.int[[2]]
           ratio <- data_ratio$estimate[[3]]
           pratio <- data_ratio$p.value[[1]]
       
           paste(ratio, pratio, lower, upper, sep = " ")
         
           }
         
         else(NA) 
         
         }
       )
   }
        
   if (colnames(input)[1] == "peptide")   {    
     ttest_data <- inputLong %>% group_by(species, quant, peptide) %>% do(
       ttest = {
         one <- .[which(.[,"condition"] == "1x"),]
         one <- one$intensity
         
         two <- .[which(.[,"condition"] == "2x"),]
         two <- two$intensity
         
         if(length(one) > 1 && length(two) > 1) {
           data_ratio <- ttestratio(two, one)
           
           lower <- data_ratio$conf.int[[1]]
           upper <- data_ratio$conf.int[[2]]
           ratio <- data_ratio$estimate[[3]]
           pratio <- data_ratio$p.value[[1]]
       
           paste(ratio, pratio, lower, upper, sep = " ")
         
           }
         
         else(NA) 
         
         }
       )
   }
  ttest_data <- ttest_data %>% filter(!is.na(ttest)) %>%
    separate(ttest, c("ratio", "p.value", "lower", "upper"), " ", convert = TRUE)

  ttest_data <- ttest_data %>% filter(!is.na(upper), !is.na(lower), !is.na(p.value))
  
  
  elim <-NA
  outLimma <-NA
  # if (colnames(input)[1] == "peptide")   {
  #   #  Limma moderated t-test
  #   limMatrix <- input[-2:-3]
  #   namaste <- limMatrix[,1]
  #   rownames(limMatrix) <-namaste
  #   limMatrix <- limMatrix[-18]
  #   limMatrix <- limMatrix[-1]
  #   designer <- read.delim("lmfit_design_matrix.txt", row.names=1)
  #   limmer <- lmFit(limMatrix, designer)
  # 
  #   #  Moderated t-statistic
  #   outLimma <- eBayes(limmer,proportion=0.17,stdev.coef.lim=c(0.1,4))
  #   elim <- qqt(outLimma$t,df=outLimma$df.prior+outLimma$df.residual,main="Moderated t")
  #   abline(0,1)
  #   #  Points off the line may be differentially expressed
  #   par(mfrow=c(1,1))
  # }
  # 
  # if (colnames(input)[1] == "protein")   {
  #   #  Limma moderated t-test
  #   limMatrix <- input[-2:-3]
  #   namaste <- limMatrix[,1]
  #   rownames(limMatrix) <-namaste
  #   limMatrix <- limMatrix[-18]
  #   limMatrix <- limMatrix[-1]
  #   designer <- read.delim("lmfit_design_matrix.txt", row.names=1)
  #   limmer <- lmFit(limMatrix, designer)
  # 
  #   #  Moderated t-statistic
  #   outLimma <- eBayes(limmer,proportion=0.17,stdev.coef.lim=c(0.1,4))
  #   elim <- qqt(outLimma$t,df=outLimma$df.prior+outLimma$df.residual,main="Moderated t")
  #   abline(0,1)
  #   #  Points off the line may be differentially expressed
  #   par(mfrow=c(1,1))
  # }


  group1 <- NA
  group2 <- NA

  if (quant=="dia" & cols == 19) {
    replicates = "8 replicates"
    group1 = c("EA100915_05_1x_dia", "EA100915_09_1x_dia", "EA100915_13_1x_dia", "EA100915_21_1x_dia", "EA100915_25_1x_dia", "EA100915_29_1x_dia", "EA100915_33_1x_dia", "EA100915_41_1x_dia")

    group2 = c("EA100915_06_2x_dia", "EA100915_10_2x_dia", "EA100915_14_2x_dia", "EA100915_18_2x_dia", "EA100915_26_2x_dia", "EA100915_30_2x_dia", "EA100915_34_2x_dia", "EA100915_38_2x_dia")
  }

  if (quant=="dda" & cols == 19) {
    replicates = "8 replicates"
    group1 = c("EA100915_03_1x_dda", "EA100915_11_1x_dda", "EA100915_15_1x_dda", "EA100915_19_1x_dda", "EA100915_23_1x_dda", "EA100915_31_1x_dda", "EA100915_35_1x_dda", "EA100915_39_1x_dda")

    group2 = c("EA100915_04_2x_dda", "EA100915_08_2x_dda", "EA100915_16_2x_dda", "EA100915_20_2x_dda", "EA100915_24_2x_dda", "EA100915_28_2x_dda", "EA100915_36_2x_dda", "EA100915_40_2x_dda")
  }

  
  # For 4 Replicates #
  
  if (quant=="dia" & cols == 11) {
    replicates = "4 replicates"
    group1 = c("EA100915_05_1x_dia", "EA100915_09_1x_dia", "EA100915_13_1x_dia", "EA100915_21_1x_dia")

    group2 = c("EA100915_06_2x_dia", "EA100915_10_2x_dia", "EA100915_14_2x_dia", "EA100915_18_2x_dia")
  }

  if (quant=="dda" & cols == 11) {
    replicates = "4 replicates"
    group1 = c("EA100915_03_1x_dda", "EA100915_11_1x_dda", "EA100915_15_1x_dda", "EA100915_19_1x_dda")

    group2 = c("EA100915_04_2x_dda", "EA100915_08_2x_dda", "EA100915_16_2x_dda", "EA100915_20_2x_dda")
  }
   peca <- NA
  # ROPECA #
  if(colnames(input)[1] == "peptide" & quant== "dia") {
    pecaDat <- input
    pecaDat$peptide <-paste(pecaDat$peptide,pecaDat$species, sep= "_")
    pecaDat <- pecaDat[,-3]
    pecaDat <- pecaDat[,-3]
    peca <- PECA_df(df = pecaDat, id = "protein", samplenames1= group1, samplenames2= group2, normalize = FALSE, test = "rots", type = "median", progress = TRUE, paired = FALSE)
  }

   rots <- NA
  # Rots #
  if (colnames(input)[1] == "protein" & cols == 19) {
    rotGroups <- c(0,1,1,0,0,1,0,1,0,1,1,0,0,1,0,1)
    rotD <- input[,-2]
    rotD <- rotD[,-2]
    rotDat <- rotD[,-1]
    rownames(rotDat) <- rotD[,1]
    rots <- ROTS(data = rotDat, groups = rotGroups, B = 1000, K = 4000)
    summary(rots, fdr = fdr)
  }
   if (colnames(input)[1] == "protein" & cols == 11) {
    rotGroups <- c(0,1,1,0,0,1,0,1)
    rotD <- input[,-2]
    rotD <- rotD[,-2]
    rotDat <- rotD[,-1]
    rownames(rotDat) <- rotD[,1]
    rots <- ROTS(data = rotDat, groups = rotGroups, B = 1000, K = 4000)
    summary(rots, fdr = fdr)
  }
  
  #Q-test
  # q <- qvalue(p = ttest_data$p.value)
  # ttest_data$q.value <- q$qvalues
  # 
  # #Q-value confusion matrix
  # confusionQTable <- data.frame("key" = character(0), "value" = numeric(0))
  # 
  # # True positives DDA
  # confusionQTable[1,1] <- "True positives"
  # confusionQTable[1,2] <- 
  #   round(nrow(ttest_data %>% filter(species == "ecoli", q.value < 0.05)), 5)
  # 
  # # False negatives DDA
  # confusionQTable[2,1] <- "False negatives"
  # confusionQTable[2,2] <-
  #   round(nrow(ttest_data %>% filter(species == "ecoli", q.value >= 0.05)), 5)
  # 
  # # False positives DDA
  # confusionQTable[3,1] <- "False positives"
  # confusionQTable[3,2] <- 
  #   round(nrow(ttest_data %>% filter(species == "human", q.value < 0.05)), 5)
  # 
  # 
  # # True negatives DDA
  # confusionQTable[4,1] <- "True negatives"
  # confusionQTable[4,2] <- 
  #   round(nrow(ttest_data %>% filter(species == "human", q.value >= 0.05)), 5)
  # 
  # # E. Coli proteins
  # confusionQTable[5,1] <- "Condition positive"
  # confusionQTable[5,2] <- round(nrow(ttest_data %>% filter(species == "ecoli")), 5)
  # 
  # # Human proteins
  # confusionQTable[6,1] <- "Condition negative"
  # confusionQTable[6,2] <- round(nrow(ttest_data %>% filter(species == "human")), 5)
  # 
  # # P < 0.05
  # confusionQTable[7,1] <- "Predicted condition positive"
  # confusionQTable[7,2] <- round(nrow(ttest_data %>% filter(q.value < 0.05)), 5)
  # 
  # # P >= 0.05
  # confusionQTable[8,1] <- "Predicted condition negative"
  # confusionQTable[8,2] <- round(nrow(ttest_data %>% filter(q.value >= 0.05)), 5)
  # 
  # # Total population
  # confusionQTable[9,1] <- "Total population"
  # confusionQTable[9,2] <- round(nrow(ttest_data), 5)
  # 
  # # Accuracy
  # confusionQTable[10,1] <- "Accuracy"
  # confusionQTable[10,2] <- round((confusionQTable[1,2] + confusionQTable[4,2]) / confusionQTable[9,2], 4)
  # 
  # # Prevalence
  # confusionQTable[11,1] <- "Prevalence"
  # confusionQTable[11,2] <- round(confusionQTable[5,2] / confusionQTable[9,2], 4)
  # 
  # # False positive rate
  # confusionQTable[12,1] <- "False positive rate"
  # confusionQTable[12,2] <- round(confusionQTable[3,2] / confusionQTable[6,2], 4)
  # 
  # # True positive rate
  # confusionQTable[13,1] <- "True positive rate"
  # confusionQTable[13,2] <- round(confusionQTable[1,2] / confusionQTable[5,2], 4)
  # 
  # # False negative rate
  # confusionQTable[14,1] <- "False negative rate"
  # confusionQTable[14,2] <- round(confusionQTable[2,2] / confusionQTable[5,2], 4)
  # 
  # # True negative rate
  # confusionQTable[15,1] <- "True negative rate"
  # confusionQTable[15,2] <- round(confusionQTable[4,2] / confusionQTable[6,2], 4)
  # 
  # # Print table
  # tab <- "q-value Confusion Table"
  # plort <- tableGrob(confusionQTable, rows = rownames(confusionQTable), cols =   colnames(confusionQTable), theme = ttheme_default(), vp = NULL)
  # grid.arrange(top = paste(input$Normalization[1], tab, sep = " "), plort)
  # 
  # #Generate ROC curve
  # ttest_data$changing <- TRUE
  # ttest_data[which(ttest_data$species == "human"), "changing"] <- FALSE
  # 
  # max(ttest_data$q.value)
  # x <- seq(0.0, 1.0, 0.01)
  # 
  # fpr <- c()
  # tpr <- c()
  # 
  # cp <- length(which(ttest_data$changing))
  # cn <- length(which(!ttest_data$changing))
  # for(i in 1:length(x)) {
  #   ttest_data$test <- FALSE
  #   ttest_data[which(ttest_data$q.value < x[i]),"test"] <- TRUE
  #   
  #   tpr[i] <- length(which(ttest_data$changing & ttest_data$test)) / cp
  #   fpr[i] <- length(which(!ttest_data$changing & ttest_data$test)) / cn
  # }
  # 
  # data_roc <- data.frame("threshold" = x, "tpr" = tpr, "fpr" = fpr)
  # 
  # g  <- ggplot(data_roc, aes(x = fpr, y = tpr, colour = threshold))
  # roc <- plot(g + geom_point() + geom_line() + 
  #   theme_pander(base_size = 19) + scale_fill_economist() +
  #   theme(text=element_text(size=19,family="serif")) +
  #   theme(axis.ticks = element_blank()) + 
  #   theme(axis.title.y=element_text(margin=margin(0,20,0,0))) + 
  #   theme(axis.title.x=element_text(margin=margin(20,0,0,0))) + 
  #   labs(x="False positive rate", y = "True positive rate") + 
  #   ggtitle(paste(input[1,]$Normalization)))
  # 
  # height = (tpr[-1]+tpr[-length(tpr)])/2
  # width = diff(fpr)
  # 
  # AUC <- sum(height*width)
   ttes <- ropecaConfusion(ttest_data, replicates, "t-test", fdr)
   tAUC <- ttes[2]
   troc <- ttes[1]
  
   if (colnames(input)[1] == "peptide")   {
     ropeca <- ropecaConfusion(peca, replicates, "Ropeca", fdr)
     roAUC <- ropeca[2]
     roroc <- ropeca[1]
   }
   if (colnames(input)[1] == "protein")   {
     ropeca <- ropecaConfusion(rots, replicates, "rots", fdr)
     roAUC <- ropeca[2]
     roroc <- ropeca[1]
   }
   
  return(list(peca,rots,outLimma,ttest_data,tAUC,troc, roAUC, roroc))
}

```

```{r Protein/Peptide Counts, echo = FALSE}
 counter <- function(input) {
  inputLong <- gather(input, run, intensity, 4:19) %>% filter(!is.na(intensity))
  dat <- colnames(input)[1]
  inputLong$condition <- NA
  inputLong[grep("1x", inputLong$run), "condition"] <- "1x"
  inputLong[grep("2x", inputLong$run), "condition"] <- "2x"

  inputLong$quant <- NA
  inputLong[grep("dia", inputLong$run), "quant"] <- "DIA"
  inputLong[grep("dda", inputLong$run), "quant"] <- "DDA"
  protein_counts <- inputLong %>% group_by(quant, condition, species) %>% 
    summarize(count = length(unique(peptide)))
  
    g <- ggplot(protein_counts, aes(x = condition, y = count, fill = species))
    g <- g + geom_bar(stat = "identity") + facet_grid(. ~ quant)
    ret <- plot(g  + theme_pander(base_size = 19) + scale_fill_economist() + 
      theme(text=element_text(size=19,family="serif")) + xlab("E. Coli spike-in ratio") + 
      ylab(paste(dat)) +  theme(axis.ticks = element_blank()) + 
      theme(axis.title.y=element_text(margin=margin(0,20,0,0))) + 
      theme(axis.title.x=element_text(margin=margin(20,0,0,0))))
 }


```

```{r ROTS Visualization, echo = FALSE}

rotsVis <- function(rotIn, pval) {
  summary(rotIn, fdr = pval)
  plot(rotIn, fdr = pval, type = "volcano")
  plot(rotIn, fdr = pval, type = "ma")
  plot(rotIn, fdr = pval, type = "reproducibility")  
  plot(rotIn, fdr = pval, type = "pvalue")
  #plot(rotIn, fdr = pval, type = "pca")
  plot(rotIn, fdr = pval, type = "heatmap")


    

}
```

```{r rotTest, echo = FALSE}
rotTest <- function(input, quant) {
    group1 <- NA
    group2 <- NA
    
    if (quant=="dia") {
      group1 = c("EA100915_05_1x_dia", "EA100915_09_1x_dia", "EA100915_13_1x_dia", "EA100915_21_1x_dia", "EA100915_25_1x_dia", "EA100915_29_1x_dia", "EA100915_33_1x_dia", "EA100915_41_1x_dia")
  
      group2 = c("EA100915_06_2x_dia", "EA100915_10_2x_dia", "EA100915_14_2x_dia", "EA100915_18_2x_dia", "EA100915_26_2x_dia", "EA100915_30_2x_dia", "EA100915_34_2x_dia", "EA100915_38_2x_dia") 
    }
    
    if (quant=="dda") {
      group1 = c("EA100915_03_1x_dda", "EA100915_11_1x_dda", "EA100915_15_1x_dda", "EA100915_19_1x_dda", "EA100915_23_1x_dda", "EA100915_31_1x_dda", "EA100915_35_1x_dda", "EA100915_39_1x_dda")
      
      group2 = c("EA100915_04_2x_dda", "EA100915_08_2x_dda", "EA100915_16_2x_dda", "EA100915_20_2x_dda", "EA100915_24_2x_dda", "EA100915_28_2x_dda	", "EA100915_36_2x_dda", "EA100915_40_2x_dda")
    }
    peca <- NA
  # ROPECA #
  if(colnames(input)[1] == "peptide") {
    pecaDat <- input[,-20]
    pecaDat$peptide <-paste(pecaDat$peptide,pecaDat$species)
    pecaDat <- pecaDat[,-2]
    pecaDat <- pecaDat[,-2]
    peca <- PECA_df(df = pecaDat, id = "peptide", samplenames1= group1, samplenames2= group2, normalize     = FALSE, test = "rots", type = "median", progress = TRUE, paired = FALSE)
  }
  
  rots <- NA
  # Rots #
  if (colnames(input)[1] == "protein") {
    rotGroups <- c(0,1,1,0,0,1,0,1,0,1,1,0,0,1,0,1)
    rotD <- input[,-20]
    rotD <- rotD[,-2]
    rotD <- rotD[,-2]
    rotDat <- rotD[,-1]
    rownames(rotDat) <- rotD[,1]
    rots <- ROTS(data = rotDat, groups = rotGroups, B = 100, K = 500)
    summary(rots, fdr =0.05)
  }
  
  return(list(peca,rots))
}
```

```{r Ropeca Confusion Matrix, echo = FALSE}
ropecaConfusion <- function(ttest_data, Norm, Stattest, fdr) {
  
  ttest_data$q.value <- NA
  if (Stattest =="t-test") {
    #Q-test
    q <- qvalue(p = ttest_data$p.value)
    ttest_data$q.value <- q$qvalues
  }
  
  if (Stattest =="Ropeca") {
    ttest_data$q.value <- ttest_data$p.fdr
  }
  
  if (Stattest =="rots") {
    #Member of a list so this may be wrong
    ttest_data$q.value <- ttest_data$pvalue
  }
  
 
  if(is.null(ttest_data$species)) {
    setDT(ttest_data, keep.rownames=TRUE)[]
    ttest_data[grep("ecoli", ttest_data$rn), "species"] <- "ecoli"
    ttest_data[grep("human", ttest_data$rn), "species"] <- "human"
  }
  
 #Q-value confusion matrix
  confusionQTable <- data.frame("key" = character(0), "value" = numeric(0))

  # True positives DDA
  confusionQTable[1,1] <- "True positives"
  confusionQTable[1,2] <- 
    round(nrow(ttest_data %>% filter(species == "ecoli", q.value < fdr)), 5)
  
  # False negatives DDA
  confusionQTable[2,1] <- "False negatives"
  confusionQTable[2,2] <-
    round(nrow(ttest_data %>% filter(species == "ecoli", q.value >= fdr)), 5)
  
  # False positives DDA
  confusionQTable[3,1] <- "False positives"
  confusionQTable[3,2] <- 
    round(nrow(ttest_data %>% filter(species == "human", q.value < fdr)), 5)
  
  
  # True negatives DDA
  confusionQTable[4,1] <- "True negatives"
  confusionQTable[4,2] <- 
    round(nrow(ttest_data %>% filter(species == "human", q.value >= fdr)), 5)
  
  # E. Coli proteins
  confusionQTable[5,1] <- "Condition positive"
  confusionQTable[5,2] <- round(nrow(ttest_data %>% filter(species == "ecoli")), 5)
  
  # Human proteins
  confusionQTable[6,1] <- "Condition negative"
  confusionQTable[6,2] <- round(nrow(ttest_data %>% filter(species == "human")), 5)
  
  # P < 0.05
  confusionQTable[7,1] <- "Predicted condition positive"
  confusionQTable[7,2] <- round(nrow(ttest_data %>% filter(q.value < fdr)), 5)
  
  # P >= 0.05
  confusionQTable[8,1] <- "Predicted condition negative"
  confusionQTable[8,2] <- round(nrow(ttest_data %>% filter(q.value >= fdr)), 5)
  
  # Total population
  confusionQTable[9,1] <- "Total population"
  confusionQTable[9,2] <- round(nrow(ttest_data), 5)
  
  # Accuracy
  confusionQTable[10,1] <- "Accuracy"
  confusionQTable[10,2] <- round((confusionQTable[1,2] + confusionQTable[4,2]) / confusionQTable[9,2], 4)
  
  # Prevalence
  confusionQTable[11,1] <- "Prevalence"
  confusionQTable[11,2] <- round(confusionQTable[5,2] / confusionQTable[9,2], 4)
  
  # False positive rate
  confusionQTable[12,1] <- "False positive rate"
  confusionQTable[12,2] <- round(confusionQTable[3,2] / confusionQTable[6,2], 4)
  
  # True positive rate
  confusionQTable[13,1] <- "True positive rate"
  confusionQTable[13,2] <- round(confusionQTable[1,2] / confusionQTable[5,2], 4)
  
  # False negative rate
  confusionQTable[14,1] <- "False negative rate"
  confusionQTable[14,2] <- round(confusionQTable[2,2] / confusionQTable[5,2], 4)
  
  # True negative rate
  confusionQTable[15,1] <- "True negative rate"
  confusionQTable[15,2] <- round(confusionQTable[4,2] / confusionQTable[6,2], 4)
  
  # Print table
  tab <- "q-value Confusion Table"
  plort <- tableGrob(confusionQTable, rows = rownames(confusionQTable), cols =   colnames(confusionQTable), theme = ttheme_default(), vp = NULL)
  grid.arrange(top = paste(Stattest, Norm, tab, sep = " "), plort)
  
  #Generate ROC curve
  ttest_data$changing <- TRUE
  ttest_data[which(ttest_data$species == "human"), "changing"] <- FALSE
  
  max(ttest_data$q.value)
  x <- seq(0.0, 1.0, 0.01)
  
  fpr <- c()
  tpr <- c()
  
  cp <- length(which(ttest_data$changing))
  cn <- length(which(!ttest_data$changing))
  for(i in 1:length(x)) {
    ttest_data$test <- FALSE
    ttest_data[which(ttest_data$q.value < x[i]),"test"] <- TRUE
    
    tpr[i] <- length(which(ttest_data$changing & ttest_data$test)) / cp
    fpr[i] <- length(which(!ttest_data$changing & ttest_data$test)) / cn
  }
  
  data_roc <- data.frame("threshold" = x, "tpr" = tpr, "fpr" = fpr)
  
  g  <- ggplot(data_roc, aes(x = fpr, y = tpr, colour = threshold))
  roc <- plot(g + geom_point() + geom_line() + 
    theme_pander(base_size = 19) + scale_fill_economist() +
    theme(text=element_text(size=19,family="serif")) +
    theme(axis.ticks = element_blank()) + 
    theme(axis.title.y=element_text(margin=margin(0,20,0,0))) + 
    theme(axis.title.x=element_text(margin=margin(20,0,0,0))) + 
    labs(x="False positive rate", y = "True positive rate") + 
    ggtitle(paste(Norm)))
  
  height = (tpr[-1]+tpr[-length(tpr)])/2
  width = diff(fpr)
  
  AUC <- sum(height*width)
  return(list(roc, AUC))
}
```

```{r Tech rep power Calc, echo = FALSE}
    repPower <- function(input, fdr, num, effect, pow) {
      # peptide name is in column 1, protein name is column 2, p value in column 3, 
      # fold change column 4, coefficient of variation in column 5, number of samples 
      # in group1 in column  6, number of samples in group 2 in column 7.
      
      pwr.2p.test(h = effect, n = num, sig.level = fdr, power = pow, 
        alternative = c("two.sided","less","greater"))
      
      #data = read.table("--------", sep="\t",header=T);
      data = input
      # If you wish to change the significance level, change it here:
      significance=fdr
      power <- array(dim=c(length(data[,1]),6));
      
      colNames=c("Peptide","Protein","Effect Size","Power","P value","Fold Change");
      colnames(power)=colNames;
      
      power[,5]=data[,3];
      power[,6]=data[,4];
      data[,4]=abs(data[,4])-1;
      
      power[,1]=as.character(data[,1]);
      power[,2]=as.character(data[,2]);
      power[,3]=data[,4]/(data[,5]);
      for (i in 1:length(data[,1])) {
      	result <- pwr.2p2n.test(h=as.numeric(power[i,3]), sig.level=data[i,3], power=NULL,
      	               n1=data[i,6], n2=data[i,7]);
      	power[i,4] <- result$power;
      
      }
      # The columns are: 1 peptide name, 2 protein name, 3 effect size, 4 power.
      #write.table(power, "--------", sep="\t");


    }
```

```{r roc curve function, echo = FALSE}


rocCurve <- function(input, id) {
  
  if (id =="ttest") {
    #Q-test
    q <- qvalue(p = input$p.value, fdr.level = 0.1)
    input$q.value <- q$qvalues
  }
  
  if (id =="ropeca") {
    input$q.value <- input$p.fdr
  }
  
  if (id =="rots") {
    #Member of a list so this may be wrong
    input$q.value <- input$pvalue
  }
  
  
  #Generate ROC curve
  input$changing <- TRUE
  input[which(input$species == "human"), "changing"] <- FALSE
  
  max(input$q.value)
  x <- seq(0.0, 1.0, 0.01)
  
  fpr <- c()
  tpr <- c()
  
  cp <- length(which(input$changing))
  cn <- length(which(!input$changing))
  
  for(i in 1:length(x)) {
    input$test <- FALSE
    input[which(input$q.value < x[i]),"test"] <- TRUE
    
    tpr[i] <- length(which(input$changing & input$test)) / cp
    fpr[i] <- length(which(!input$changing & input$test)) / cn
  }
  
  data_roc <- data.frame("threshold" = x, "tpr" = tpr, "fpr" = fpr)
  
  g  <- ggplot(data_roc, aes(x = fpr, y = tpr, colour = threshold))
  roc <- plot(g + geom_point() + geom_line() + 
    theme_pander(base_size = 19) + scale_fill_economist() +
    theme(text=element_text(size=19,family="serif")) +
    theme(axis.ticks = element_blank()) + 
    theme(axis.title.y=element_text(margin=margin(0,20,0,0))) + 
    theme(axis.title.x=element_text(margin=margin(20,0,0,0))) + 
    labs(x="False positive rate", y = "True positive rate") + 
    ggtitle(paste(input[1,]$Normalization)))
  
  height = (tpr[-1]+tpr[-length(tpr)])/2
  width = diff(fpr)
  
  AUC <- sum(height*width)
  return(list(roc,AUC))
}
```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

```{r , echo = FALSE}

```

